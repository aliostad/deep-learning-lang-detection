create or replace view HV_EQUITY_PRICE_CHECK AS
SELECT SCHNAVBD.SECURITY,
  SECURITY.STK_SEC_ID,
  -SUM(SCHNAVBD.AMOUNT)/SUM(SCHNAVBD.UNITS) AMT,
  SECURITY.TICKER,
  NSE.NSE_CODE AS NSE_CODE,
  NSE.NSE_CLOSE AS NSE_CLOSE,
  BSE.BSE_CLOSE AS BSE_CLOSE,
  SCHNAVBD.NAV_DATE
FROM HI_SCHNAVBD_CURR SCHNAVBD,
  HM_SECURITY SECURITY,
  HI_BSE BSE,
  HI_NSE NSE
WHERE TRIM(NSE.NSE_CODE)      = SCHNAVBD.SECURITY
AND NSE.NSE_DT          = SCHNAVBD.NAV_DATE
AND TRIM(BSE.BSE_CODE)        = SECURITY.TICKER
AND BSE.VALUE_DATE              = SCHNAVBD.NAV_DATE
AND SCHNAVBD.SECURITY   = SECURITY.SECURITY
AND (
/*(SCHNAVBD.NAV_DATE =
  (SELECT CUR_DATE-1 FROM SYSPARAM WHERE RECTYPE='L'
  ))
AND*/ (SCHNAVBD.INVEST_TYPE ='INVEST')
AND (SCHNAVBD.UNITS      <>'0')
AND (SECURITY.ASSET_TYPE  ='01')
AND (SECURITY.SECURITY   <>SECURITY.STK_SEC_ID)
AND (SCHNAVBD.SCHEME NOT IN ('HDFCSX','HDFCS+','HDFCNY'))
AND (SECURITY.RECTYPE     ='L')
)
AND SECURITY.SECURITY    <>'ARSSINF'
GROUP BY SCHNAVBD.SECURITY,
  SECURITY.STK_SEC_ID,
  SECURITY.TICKER,
  BSE.BSE_CODE,
  NSE.NSE_CODE,
  NSE.NSE_CLOSE,
  BSE.BSE_CLOSE,
  SCHNAVBD.NAV_DATE
ORDER BY 1,
  2;
 
