DELIMITER $$

DROP TRIGGER IF EXISTS `storages_changes_insert` $$

CREATE TRIGGER `storages_changes_insert` AFTER INSERT ON `storages` 
FOR EACH ROW BEGIN

IF EXISTS (SELECT 1 FROM hardware hw WHERE hw.ID = NEW.HARDWARE_ID AND hw.UUID NOT IN (SELECT v.UUID FROM virtualmachines v) ) 
	THEN
	INSERT INTO `storages_changes` (STORAGE_ID, HARDWARE_ID, NAME, MODEL, TYPE, DISKSIZE, SERIALNUMBER)
		SELECT NEW.ID, NEW.HARDWARE_ID, NEW.NAME, NEW.MODEL, NEW.TYPE, NEW.DISKSIZE, NEW.SERIALNUMBER 
		FROM dual
		WHERE (NEW.TYPE = 'disk' OR NEW.TYPE = 'Fixed hard disk media')
	ON DUPLICATE KEY UPDATE
		STORAGE_ID=NEW.ID,
		DELETED=FALSE;
	END IF;
END$$

DELIMITER ;
