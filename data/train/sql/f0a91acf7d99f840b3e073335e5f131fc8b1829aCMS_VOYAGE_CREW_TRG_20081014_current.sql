CREATE OR REPLACE TRIGGER cms_voyage_crew_trg
BEFORE DELETE OR INSERT OR UPDATE
ON TPJ.CMS_VOYAGE_CREW
REFERENCING NEW AS NEW OLD AS OLD
FOR EACH ROW
BEGIN
   IF INSERTING THEN
      update pms_employees 
      set    vess_code = :NEW.VOYA_VESS_CODE,
             latest_embarked = :NEW.DT_EMBARKED 
      where  empl_id   = :NEW.EMPL_EMPL_ID
      and    (latest_embarked is null
      or      latest_embarked < :NEW.DT_EMBARKED);

      INSERT INTO cms_voyage_crew_audit
            ( ACTION, USER_ID, NEW_VOYA_VESS_CODE, NEW_VOYA_VOYAGE_DATE, NEW_EMPL_EMPL_ID,
              NEW_CREATED_BY, NEW_DT_CREATED, NEW_MODIFIED_BY, NEW_DT_MODIFIED,
              NEW_RANK_CODE, NEW_TITLE, NEW_SEQ_NO, NEW_DT_EMBARKED, NEW_DT_DISEMBARKED,
              NEW_PASSENGER, NEW_BASIC_RATE, NEW_APPROVED, NEW_BASIC_RATE_G, NEW_TRAN_NO_EMBARKED,
              NEW_TRAN_NO_DISEMBARKED )
      VALUES ('I', USER, :NEW.VOYA_VESS_CODE, :NEW.VOYA_VOYAGE_DATE, :NEW.EMPL_EMPL_ID,
              :NEW.CREATED_BY, :NEW.DT_CREATED, :NEW.MODIFIED_BY, :NEW.DT_MODIFIED, 
              :NEW.RANK_CODE, :NEW.TITLE, :NEW.SEQ_NO, :NEW.DT_EMBARKED, :NEW.DT_DISEMBARKED,
              :NEW.PASSENGER, :NEW.BASIC_RATE, :NEW.APPROVED, :NEW.BASIC_RATE_G, :NEW.TRAN_NO_EMBARKED,
              :NEW.TRAN_NO_DISEMBARKED);
   END IF;

   IF UPDATING THEN
      update pms_employees 
      set    vess_code = :NEW.VOYA_VESS_CODE,
             latest_embarked = :NEW.DT_EMBARKED 
      where  empl_id   = :NEW.EMPL_EMPL_ID
      and    (latest_embarked is null
      or      latest_embarked < :NEW.DT_EMBARKED);

      INSERT INTO cms_voyage_crew_audit
            ( ACTION, USER_ID, NEW_VOYA_VESS_CODE, NEW_VOYA_VOYAGE_DATE, NEW_EMPL_EMPL_ID,
              NEW_CREATED_BY, NEW_DT_CREATED, NEW_MODIFIED_BY, NEW_DT_MODIFIED,
              NEW_RANK_CODE, NEW_TITLE, NEW_SEQ_NO, NEW_DT_EMBARKED, NEW_DT_DISEMBARKED,
              NEW_PASSENGER, NEW_BASIC_RATE, NEW_APPROVED, NEW_BASIC_RATE_G, NEW_TRAN_NO_EMBARKED,
              NEW_TRAN_NO_DISEMBARKED, OLD_VOYA_VESS_CODE, OLD_VOYA_VOYAGE_DATE, OLD_EMPL_EMPL_ID,
              OLD_CREATED_BY, OLD_DT_CREATED, OLD_MODIFIED_BY, OLD_DT_MODIFIED, OLD_RANK_CODE,
              OLD_TITLE, OLD_SEQ_NO, OLD_DT_EMBARKED, OLD_DT_DISEMBARKED, OLD_PASSENGER, OLD_BASIC_RATE,
              OLD_APPROVED, OLD_BASIC_RATE_G, OLD_TRAN_NO_EMBARKED, OLD_TRAN_NO_DISEMBARKED )
      VALUES ('U', USER, :NEW.VOYA_VESS_CODE, :NEW.VOYA_VOYAGE_DATE, :NEW.EMPL_EMPL_ID,
              :NEW.CREATED_BY, :NEW.DT_CREATED, :NEW.MODIFIED_BY, :NEW.DT_MODIFIED,
              :NEW.RANK_CODE, :NEW.TITLE, :NEW.SEQ_NO, :NEW.DT_EMBARKED, :NEW.DT_DISEMBARKED,
              :NEW.PASSENGER, :NEW.BASIC_RATE, :NEW.APPROVED, :NEW.BASIC_RATE_G, :NEW.TRAN_NO_EMBARKED,
              :NEW.TRAN_NO_DISEMBARKED, :OLD.VOYA_VESS_CODE, :OLD.VOYA_VOYAGE_DATE,
              :OLD.EMPL_EMPL_ID, :OLD.CREATED_BY, :OLD.DT_CREATED, :OLD.MODIFIED_BY, :OLD.DT_MODIFIED,
              :OLD.RANK_CODE, :OLD.TITLE, :OLD.SEQ_NO, :OLD.DT_EMBARKED, :OLD.DT_DISEMBARKED,
              :OLD.PASSENGER, :OLD.BASIC_RATE, :OLD.APPROVED, :OLD.BASIC_RATE_G, :OLD.TRAN_NO_EMBARKED,
              :OLD.TRAN_NO_DISEMBARKED);
   END IF;

   IF DELETING THEN
      INSERT INTO cms_voyage_crew_audit
            ( ACTION, USER_ID, NEW_VOYA_VESS_CODE, NEW_VOYA_VOYAGE_DATE, NEW_EMPL_EMPL_ID,
              NEW_CREATED_BY, NEW_DT_CREATED, NEW_MODIFIED_BY, NEW_DT_MODIFIED, NEW_RANK_CODE,
              NEW_TITLE, NEW_SEQ_NO, NEW_DT_EMBARKED, NEW_DT_DISEMBARKED, NEW_PASSENGER,
              NEW_BASIC_RATE, NEW_APPROVED, NEW_BASIC_RATE_G, NEW_TRAN_NO_EMBARKED,
              NEW_TRAN_NO_DISEMBARKED )
      VALUES ('D', USER, :OLD.VOYA_VESS_CODE, :OLD.VOYA_VOYAGE_DATE, :OLD.EMPL_EMPL_ID,
              :OLD.CREATED_BY, :OLD.DT_CREATED, :OLD.MODIFIED_BY, :OLD.DT_MODIFIED, :OLD.RANK_CODE,
              :OLD.TITLE, :OLD.SEQ_NO, :OLD.DT_EMBARKED, :OLD.DT_DISEMBARKED, :OLD.PASSENGER,
              :OLD.BASIC_RATE, :OLD.APPROVED, :OLD.BASIC_RATE_G, :OLD.TRAN_NO_EMBARKED,
              :OLD.TRAN_NO_DISEMBARKED);
   END IF;
END;
/
