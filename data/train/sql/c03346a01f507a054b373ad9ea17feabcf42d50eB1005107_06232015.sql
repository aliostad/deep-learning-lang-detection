CREATE TABLE TEMP_QUARTER_DX_INFO PARTITION BY LIST(MONTH_ID)
(PARTITION M201201 VALUES (201201)) NOLOGGING PARALLEL 4 AS
SELECT A.MONTH_ID
       ,B.IDW_PATIENT_ID
       ,A.IMS_PAT_NBR
       ,A.DX_CD
       ,A.PROCEDURE_CD
FROM DX_TRANSACTION_TAB_R1 A
INNER JOIN TMP_SCH_PAT_XREF_0415 B
ON(A.IMS_PAT_NBR=B.PAT_IDB_COMB+1005107)
WHERE A.MONTH_ID=201201
AND 1=2;


BEGIN
  FOR X IN (SELECT DISTINCT MONTH_ID FROM V_CALENDAR@IDW WHERE MONTH_ID BETWEEN 201201 AND 201410 ORDER BY 1)
    LOOP
    P_TRUNCATE_OR_CREATE_PARTITION(PV_TABLE_NAME     => 'TEMP_QUARTER_DX_INFO',
                                   PV_PART_NAME      => 'M'||TO_CHAR(X.MONTH_ID),
                                   PV_THRU_VAL       => TO_CHAR(X.MONTH_ID),
                                   PV_STORAGE_CLAUSE => NULL);
      INSERT /* +APPEND */  INTO TEMP_QUARTER_DX_INFO
      SELECT A.MONTH_ID
            ,B.IDW_PATIENT_ID
            ,A.IMS_PAT_NBR
            ,A.DX_CD
            ,A.PROCEDURE_CD
     FROM DX_TRANSACTION_TAB_R1 A
     INNER JOIN TMP_SCH_PAT_XREF_0415 B
     ON(A.IMS_PAT_NBR=B.PAT_IDB_COMB+1005107)
     WHERE A.MONTH_ID = X.MONTH_ID;
    COMMIT;
  END LOOP;
  
  FOR X IN (SELECT DISTINCT MONTH_ID FROM V_CALENDAR@IDW WHERE MONTH_ID BETWEEN 201411 AND 201412 ORDER BY 1)
    LOOP
    P_TRUNCATE_OR_CREATE_PARTITION(PV_TABLE_NAME     => 'TEMP_QUARTER_DX_INFO',
                                   PV_PART_NAME      => 'M'||TO_CHAR(X.MONTH_ID),
                                   PV_THRU_VAL       => TO_CHAR(X.MONTH_ID),
                                   PV_STORAGE_CLAUSE => NULL);
      INSERT /* +APPEND */  INTO TEMP_QUARTER_DX_INFO
      SELECT A.MONTH_ID
            ,B.IDW_PATIENT_ID
            ,A.IMS_PAT_NBR
            ,A.DX_CD
            ,A.PROCEDURE_CD
     FROM DX_TRANSACTION_TAB_R0415 A
     INNER JOIN TMP_SCH_PAT_XREF_0415 B
     ON(A.IMS_PAT_NBR=B.PAT_IDB_COMB+1005107)
     WHERE A.MONTH_ID = X.MONTH_ID;
    COMMIT;
  END LOOP;
END;

CREATE TABLE TEMP_QUARTER_DX_INFO_2 NOLOGGING PARALLEL 4 AS
SELECT DISTINCT IDW_PATIENT_ID,IMS_PAT_NBR,DX_CD,PROCEDURE_CD FROM TEMP_QUARTER_DX_INFO;

CREATE TABLE B1005017_QUARTER_DX_INFO NOLOGGING PARALLEL 4 AS
SELECT A.*
      ,B.DIAGNOSIS_LEVEL_1 AS PRODUCT_GROUP
FROM TEMP_QUARTER_DX_INFO_2 A
INNER JOIN QC_NP_DIAG_LIST B
ON (A.DX_CD = B.DX_CD)
UNION ALL
SELECT A.*
      ,C.PROCEDURE_LEVEL_1 AS PRODUCT_GROUP
FROM TEMP_QUARTER_DX_INFO_2 A
INNER JOIN QC_NP_PROC_LIST C
ON (A.PROCEDURE_CD = C.PROCEDURE_CD);
