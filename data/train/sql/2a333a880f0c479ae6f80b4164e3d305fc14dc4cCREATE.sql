USE [AUTOMATION 2]

DROP VIEW OPTIONOFCARPACKAGE
DROP TABLE CAR_PACKAGE
DROP TABLE CAR_OPTION
DROP TABLE P_OPTION
DROP TABLE MODEL_PACKAGE
DROP TABLE SALE
DROP TABLE SALESPERSON
DROP TABLE CUSTOMER
DROP TABLE M_OPTIONS
DROP TABLE OPTIONS
DROP TABLE CAR
DROP TABLE MODEL


IF OBJECT_ID('ModelNoControlCarPackage') IS NOT NULL
    DROP FUNCTION ModelNoControlCarPackage
IF OBJECT_ID('ModelNoContrlCarOption') IS NOT NULL
    DROP FUNCTION dbo.ModelNoContrlCarOption
IF OBJECT_ID('numberOfOption') IS NOT NULL
    DROP FUNCTION dbo.numberOfOption
IF OBJECT_ID('AddPackageForUnSoldCar') IS NOT NULL
    DROP FUNCTION dbo.AddPackageForUnSoldCar
IF OBJECT_ID('AddOptionForUnSoldCar') IS NOT NULL
    DROP FUNCTION dbo.AddOptionForUnSoldCar
IF OBJECT_ID('PaketInceleme') IS NOT NULL
    DROP FUNCTION PaketInceleme
IF OBJECT_ID('modelNoAl') IS NOT NULL
    DROP FUNCTION dbo.modelNoAl



CREATE TABLE MODEL
(
	ModelNO INT PRIMARY KEY,
	ModelName VARCHAR(15) UNIQUE NOT NULL,
	Manufacture VARCHAR(15),
	Price FLOAT NOT NULL,
	CHECK (Price>0)
);

CREATE TABLE CAR
(
	SerialNO VARCHAR(9) PRIMARY KEY,
	ModelNO INT FOREIGN KEY REFERENCES MODEL(ModelNO)
);

CREATE TABLE OPTIONS
(
	OptionNO INT PRIMARY KEY,
	OptionName VARCHAR(15) NOT NULL,
	OptionPrice FLOAT NOT NULL,
	CHECK(OptionPrice>0)
);

CREATE TABLE M_OPTIONS
(
	ModelNO INT,
	OptionNO INT UNIQUE,
	PRIMARY KEY(ModelNO,OptionNO),
	FOREIGN KEY(ModelNO) REFERENCES MODEL(ModelNO),
	FOREIGN KEY(OptionNO) REFERENCES OPTIONS(OptionNO)
);

CREATE TABLE CUSTOMER
(
	CustomerID VARCHAR(4) PRIMARY KEY,
	CustomerFName VARCHAR(16) NOT NULL,
	CustomerLName VARCHAR(16) NOT NULL
);

CREATE TABLE SALESPERSON
(
	SPID VARCHAR(3) PRIMARY KEY,
	SPFName VARCHAR(15) NOT NULL,
	SPLName VARCHAR(15) NOT NULL,
	SPAddress VARCHAR(39),
	SPPhone VARCHAR(11)
);

CREATE TABLE SALE
(
	SPID VARCHAR(3) ,
	SerialNO VARCHAR(9) unique,
	CustomerID VARCHAR(4),
	SDate DATE,
	SPrice FLOAT,
	PRIMARY KEY (SPID,SerialNO,CustomerID),
	FOREIGN KEY(SPID) REFERENCES SALESPERSON(SPID),
	FOREIGN KEY(SerialNO) REFERENCES CAR(SerialNO) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY(CustomerID) REFERENCES CUSTOMER(CustomerID)
);

CREATE TABLE MODEL_PACKAGE
(
	ModelNO INT,
	PackageNO INT UNIQUE,
	PackagePrice FLOAT,
	PRIMARY KEY(ModelNO,PackageNO),
	FOREIGN KEY(ModelNO) REFERENCES MODEL(ModelNO)
);

CREATE TABLE P_OPTION
(
	ModelNO INT,
	PackageNO INT,
	OptNO INT,
	PRIMARY KEY (ModelNO,PackageNO,OptNO),
	FOREIGN KEY(ModelNO,PackageNO) REFERENCES MODEL_PACKAGE(ModelNO,PackageNO),
	FOREIGN KEY(ModelNO,OptNO) REFERENCES M_OPTIONS(ModelNO,OptionNO)
);


CREATE TABLE CAR_OPTION
(
	SerialNO VARCHAR(9),
	OptNO INT,
	ModelNO INT,
	FOREIGN KEY(ModelNO,OptNO) REFERENCES M_OPTIONS(ModelNO,OptionNO),
	FOREIGN KEY(SerialNO) REFERENCES CAR(SerialNO) ON DELETE CASCADE ON UPDATE CASCADE,
	PRIMARY KEY(SerialNO,OptNO)
);

CREATE TABLE CAR_PACKAGE
(
	SerialNO VARCHAR(9) ,
	PackageNO INT,
	ModelNO INT,
	PRIMARY KEY(SerialNO,PackageNO),
	FOREIGN KEY(ModelNO,PackageNO) REFERENCES MODEL_PACKAGE(ModelNO,PackageNO),
	FOREIGN KEY(SerialNO) REFERENCES CAR(SerialNO) ON DELETE CASCADE ON UPDATE CASCADE
);
GO
CREATE VIEW OPTIONOFCARPACKAGE
	AS SELECT  c.SerialNo,p.OptNo,c.PackageNO
	FROM CAR_PACKAGE C,P_OPTION P
	WHERE c.PackageNO=p.PackageNO and p.OptNO IN
		(			
			SELECT P.OptNO
			FROM CAR_PACKAGE C,P_OPTION P
			WHERE C.PackageNO=P.PackageNO
		);