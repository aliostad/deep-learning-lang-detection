@model IEnumerable<LiteDispatch.Domain.Models.DispatchNoteModel>

@{
    ViewBag.Title = "Haulier - Active Dispatch Notes";    
}
@section headSection{
    <script src="~/Scripts/jquery.signalR-1.1.0.js" type="text/javascript"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs" type="text/javascript"></script>
}

@section featured {
    <section class="featured">
        <div class="content-wrapper">
            <div id="detail_up" class="float-right"><img src="~/Images/deploy_chevronup.gif"/></div>
            <div id="detail_down" class="float-right"><img src="~/Images/deploy_chevrondown.gif"/></div>
            <hgroup class="title">
                <h1>@ViewBag.Title</h1>                
                <br/>
                <h2>@ViewBag.Message</h2>                
            </hgroup>
            <div id="featured_detail">
                <p>
                    <h5>Design Notes</h5>
                    This page display active dispatch notes for a determined haulier<br/>
                    <h5>Comments</h5>
                    Currently this page displays all active dispatches for all hauliers
                </p>
            </div>
        </div>
    </section>
}

@if (Model.Any())
{
    <table id="dispatches">
        <thead>
            <th>Haulier</th>
            <th>Date</th>
            <th>Reference</th>
            <th>Truck</th>
            <th>State</th>
            <th>Last Update (utc)</th>
            <th>Lines</th>
            <th>Duration</th>
            <th>Distance (km)</th>
            <th></th>
        </thead>
        @foreach (var listado in Model)
        {            
            @Html.Partial("GetDispatchNoteDetails", listado)            
        }
    </table>
    <input type="hidden" id="userName"/>
    <input type="button" id="sendMessage" value="Send Message"/>    
}
else
{
    <p>No active dispatch notes are available</p>
}
@section scripts
{
    <script type="text/javascript">
        $(document).ready(function () {
            setDispatchesStyle();
        });
        var setDispatchesStyle = function() {
            $("#dispatches > tbody tr:odd").css("background-color", "#F7F7F7");
            $("#dispatches > tbody tr:even").css("background-color", "#EFEEEF");
            $("#dispatches > thead th").css("padding-right", "20px"); // ToDo: Use CSS to do this
        };
        
    </script>
    <script src="~/Scripts/feature-detail.js" type="text/javascript"></script>
    <script type="text/javascript">
        // Reference the auto-generated proxy for the hub.
        var chat = $.connection.liteDispatchHub;
        
        // Function that the hub calls back
        chat.client.addNewMessageToPage = function(name, message) {
            alert("Message from: " + name + "\r\r" + message);
        };

        chat.client.newDispatch = function (dispatchId) {
            alert("A new DispatchNote was created by other user with Id: " + dispatchId);
            $.get('@Url.Action("GetDispatchNoteDetails", "Dispatch")' + '?dispatchId=' + dispatchId, function (html) {
                renderDispatch(dispatchId, html);
            });
        };
       
        chat.client.updateDispatch = function (dispatchId) {
            alert("An existing DispatchNote was updated by other user with Id: " + dispatchId);
            $.get('@Url.Action("GetDispatchNoteDetails","Dispatch")' + '?dispatchId=' + dispatchId, function (html) {
                $('#dispatch_' + dispatchId).hide("slow").remove();
                renderDispatch(dispatchId, html);
            });
        };

        var renderDispatch = function (dispatchId, html) {
            $('#dispatches').prepend(html);
            $('#dispatch_' + dispatchId).hide();
            setDispatchesStyle();
            linksToButtons();
            $('#dispatch_' + dispatchId).show(2000);
        };

        $.connection.hub.start().done(function () {
            $('#sendMessage').click(function () {
                var userName = $('#userName').val();
                if (userName == "") {
                    $('#userName').val(prompt('Enter your name:', ''));
                    userName = $('#userName').val();
                }
                var message = prompt('Message:', '');
                chat.server.send(userName, message);
            });
        });

    </script>
}