
  CREATE OR REPLACE  VIEW HV_EQUITY_CHECK_EOD (SOURCE, SECURITY, STK_SEC_ID, AMT, TICKER, NSE_CODE, CLOSE, NAV_DATE, S_STK_ID) AS 
  SELECT 'NSE' AS SOURCE,
  SCHNAVBD.SECURITY,
    SECURITY.STK_SEC_ID,
    -SUM(SCHNAVBD.AMOUNT)/SUM(SCHNAVBD.UNITS) AMT,
    SECURITY.TICKER,
    NSE.SYMBOL AS NSE_CODE,
    NSE.CLOSE  AS CLOSE,
    SCHNAVBD.NAV_DATE,
    SUBSTR(SECURITY.STK_SEC_ID,3,(LENGTH(SECURITY.STK_SEC_ID)-2)) S_STK_ID
  FROM HI_SCHNAVBD_CURR SCHNAVBD,
    HM_SECURITY SECURITY,
    HTMP_NSE_EXT NSE
  WHERE TRIM(NSE.SYMBOL) = SUBSTR(SECURITY.STK_SEC_ID,3,(LENGTH(SECURITY.STK_SEC_ID)-2)) --SCHNAVBD.SECURITY
  --AND NSE.UPD_DT         = SCHNAVBD.NAV_DATE
  AND SCHNAVBD.SECURITY  = SECURITY.SECURITY
  AND ((SCHNAVBD.INVEST_TYPE   ='INVEST')
  AND (SCHNAVBD.UNITS      <>'0')
  AND (SECURITY.ASSET_TYPE  ='01')
  AND (SECURITY.SECURITY   <>SECURITY.STK_SEC_ID)
  AND (SCHNAVBD.SCHEME NOT IN ('HDFCSX','HDFCS+','HDFCNY'))
  AND (SECURITY.RECTYPE     ='L') )
  AND SECURITY.SECURITY    <>'ARSSINF'
  AND NSE.SERIES            = 'EQ'
  GROUP BY SCHNAVBD.SECURITY,
    SECURITY.STK_SEC_ID,
    SECURITY.TICKER,
    NSE.SYMBOL,
    NSE.CLOSE,
    SCHNAVBD.NAV_DATE
    UNION ALL
    SELECT 'BSE' AS SOURCE, 
 SCHNAVBD.SECURITY,
    SECURITY.STK_SEC_ID,
    -SUM(SCHNAVBD.AMOUNT)/SUM(SCHNAVBD.UNITS) AMT,
    SECURITY.TICKER,
   NULL AS NSE_CODE,
    BSE.CLOSE AS CLOSE,
    SCHNAVBD.NAV_DATE,
    SUBSTR(SECURITY.STK_SEC_ID,3,(LENGTH(SECURITY.STK_SEC_ID)-2)) S_STK_ID
  FROM HI_SCHNAVBD_CURR SCHNAVBD,
    HM_SECURITY SECURITY,
    HTMP_BSE_EXT BSE
  WHERE --CAST(REGEXP_REPLACE(BSE.SC_CODE, '[^0-9]+', '') AS NUMBER)  = SECURITY.TICKER
  BSE.SC_CODE  = to_char(SECURITY.TICKER)
  --AND BSE.UPD_DT              = SCHNAVBD.NAV_DATE
  AND SCHNAVBD.SECURITY       = SECURITY.SECURITY
  AND ( (SCHNAVBD.INVEST_TYPE ='INVEST')
  AND (SCHNAVBD.UNITS        <>'0')
  AND (SECURITY.ASSET_TYPE    ='01')
  AND (SECURITY.SECURITY     <>SECURITY.STK_SEC_ID)
  AND (SCHNAVBD.SCHEME NOT   IN ('HDFCSX','HDFCS+','HDFCNY'))
  AND (SECURITY.RECTYPE       ='L') )
  AND SECURITY.SECURITY      <>'ARSSINF'
  and SUBSTR(SECURITY.STK_SEC_ID,3,(LENGTH(SECURITY.STK_SEC_ID)-2)) not in (select nse.symbol from HTMP_NSE_EXT NSE)
  GROUP BY SCHNAVBD.SECURITY,
    SECURITY.STK_SEC_ID,
    SECURITY.TICKER,
    BSE.SC_CODE,
    BSE.CLOSE,
    SCHNAVBD.NAV_DATE;
 
